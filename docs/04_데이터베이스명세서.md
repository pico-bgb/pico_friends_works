# PICOFriends 데이터베이스 명세서

## 1. 데이터베이스 정보
- **DBMS**: MySQL 8.0+ / PostgreSQL 14+
- **Character Set**: UTF-8 (utf8mb4)
- **Collation**: utf8mb4_unicode_ci
- **Timezone**: Asia/Seoul

## 2. ERD (Entity Relationship Diagram)

```
┌─────────────────┐       ┌──────────────────┐       ┌─────────────────┐
│     Users       │       │ WorkAssignments  │       │   Pharmacies    │
├─────────────────┤       ├──────────────────┤       ├─────────────────┤
│ PK id           │───┐   │ PK id            │   ┌───│ PK id           │
│    email        │   │   │ FK user_id       │───┘   │    name         │
│    password     │   │   │ FK work_id       │       │    address      │
│    name         │   │   │ FK pharmacy_id   │───┐   │    phone_number │
│    phone_number │   │   │    status        │   │   │    ...          │
│    university   │   │   │    visited_at    │   │   └─────────────────┘
│    role         │   │   │    registered_at │   │
│    status       │   │   │    survey_url    │   │
│    admin_comment│   │   │    survey_comp..│   │
│    created_at   │   │   │    created_at    │   │
│    updated_at   │   │   │    updated_at    │   │
│    deleted_at   │   │   │    deleted_at    │   │
└─────────────────┘   │   └──────────────────┘   │
                      │                            │
                      │   ┌──────────────────┐   │
                      │   │      Works       │   │
                      │   ├──────────────────┤   │
                      └───│ PK id            │───┘
                          │    title         │
                          │    description   │
                          │    status        │
                          │    start_date    │
                          │    end_date      │
                          │    created_at    │
                          │    updated_at    │
                          │    deleted_at    │
                          └──────────────────┘
                              │
                              │
┌─────────────────┐           │           ┌─────────────────────┐
│  VisitRecords   │           │           │ RegistrationRecords │
├─────────────────┤           │           ├─────────────────────┤
│ PK id           │           │           │ PK id               │
│ FK user_id      │───────────┤           │ FK user_id          │
│ FK pharmacy_id  │           │           │ FK pharmacy_id      │
│ FK work_assign..│           │           │ FK work_assignment..│
│    visited_at   │           │           │    registered_at    │
│    notes        │           │           │    notes            │
│    created_at   │           │           │    created_at       │
│    updated_at   │           └───────────│    updated_at       │
│    deleted_at   │                       │    deleted_at       │
└─────────────────┘                       └─────────────────────┘

┌─────────────────┐
│     Notices     │
├─────────────────┤
│ PK id           │
│    category     │
│    title        │
│    content      │
│    author       │
│    has_image    │
│    view_count   │
│    created_at   │
│    updated_at   │
│    deleted_at   │
└─────────────────┘
```

## 3. 테이블 상세 설계

### 3.1 users (사용자)
**설명**: 시스템 사용자 정보를 관리하는 테이블 (관리자 및 피코프렌즈)

| 컬럼명 | 데이터 타입 | NULL | 키 | 기본값 | 설명 |
|--------|------------|------|-----|--------|------|
| id | BIGINT | NO | PK | AUTO_INCREMENT | 사용자 ID |
| email | VARCHAR(100) | NO | UQ | | 이메일 주소 (로그인 ID) |
| password | VARCHAR(255) | NO | | | 암호화된 비밀번호 (BCrypt) |
| name | VARCHAR(50) | NO | | | 사용자 이름 |
| phone_number | VARCHAR(20) | NO | | | 전화번호 (010-1234-5678) |
| university | VARCHAR(50) | NO | | | 소속 대학교 (37개 중 1개) |
| role | VARCHAR(20) | NO | | | 역할 (ADMIN, PICOFRIEND) |
| status | VARCHAR(20) | NO | | PENDING | 승인 상태 (PENDING, APPROVED, REJECTED) |
| admin_comment | TEXT | YES | | NULL | 관리자 코멘트 |
| created_at | DATETIME | NO | | CURRENT_TIMESTAMP | 생성 일시 |
| updated_at | DATETIME | NO | | CURRENT_TIMESTAMP | 수정 일시 |
| deleted_at | DATETIME | YES | | NULL | 삭제 일시 (Soft Delete) |

**인덱스**:
```sql
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_university ON users(university);
CREATE INDEX idx_users_created_at ON users(created_at);
```

**제약 조건**:
```sql
ALTER TABLE users
  ADD CONSTRAINT chk_users_role CHECK (role IN ('ADMIN', 'PICOFRIEND')),
  ADD CONSTRAINT chk_users_status CHECK (status IN ('PENDING', 'APPROVED', 'REJECTED'));
```

### 3.2 pharmacies (약국)
**설명**: 약국 정보를 관리하는 테이블

| 컬럼명 | 데이터 타입 | NULL | 키 | 기본값 | 설명 |
|--------|------------|------|-----|--------|------|
| id | BIGINT | NO | PK | AUTO_INCREMENT | 약국 ID |
| name | VARCHAR(100) | NO | | | 약국명 |
| address | VARCHAR(255) | NO | | | 약국 주소 |
| phone_number | VARCHAR(20) | YES | | NULL | 약국 전화번호 |
| pharmacist_name | VARCHAR(50) | YES | | NULL | 약사님 성함 |
| pharmacist_contact | VARCHAR(20) | YES | | NULL | 약사님 연락처 |
| online_usage_status | TEXT | YES | | NULL | 온라인 이용 현황 |
| main_products | TEXT | YES | | NULL | 주력 판매 상품군 |
| urgent_needs | TEXT | YES | | NULL | 시급하게 필요한 제품/서비스 |
| marketing_concerns | TEXT | YES | | NULL | 마케팅/홍보 관련 고민 |
| pico_response | TEXT | YES | | NULL | 피코 안내 후 반응 |
| field_activity_summary | TEXT | YES | | NULL | 현장활동 요약 (필수) |
| next_step_plan | TEXT | YES | | NULL | 다음 단계 계획 |
| created_at | DATETIME | NO | | CURRENT_TIMESTAMP | 생성 일시 |
| updated_at | DATETIME | NO | | CURRENT_TIMESTAMP | 수정 일시 |
| deleted_at | DATETIME | YES | | NULL | 삭제 일시 (Soft Delete) |

**인덱스**:
```sql
CREATE INDEX idx_pharmacies_name ON pharmacies(name);
CREATE INDEX idx_pharmacies_address ON pharmacies(address);
CREATE INDEX idx_pharmacies_created_at ON pharmacies(created_at);
```

### 3.3 works (업무)
**설명**: 업무 정보를 관리하는 테이블

| 컬럼명 | 데이터 타입 | NULL | 키 | 기본값 | 설명 |
|--------|------------|------|-----|--------|------|
| id | BIGINT | NO | PK | AUTO_INCREMENT | 업무 ID |
| title | VARCHAR(200) | NO | | | 업무 제목 |
| description | TEXT | YES | | NULL | 업무 설명 |
| status | VARCHAR(20) | NO | | PENDING | 업무 상태 (PENDING, IN_PROGRESS, COMPLETED) |
| start_date | DATE | YES | | NULL | 시작일 |
| end_date | DATE | YES | | NULL | 종료일 |
| created_at | DATETIME | NO | | CURRENT_TIMESTAMP | 생성 일시 |
| updated_at | DATETIME | NO | | CURRENT_TIMESTAMP | 수정 일시 |
| deleted_at | DATETIME | YES | | NULL | 삭제 일시 (Soft Delete) |

**인덱스**:
```sql
CREATE INDEX idx_works_status ON works(status);
CREATE INDEX idx_works_start_date ON works(start_date);
CREATE INDEX idx_works_end_date ON works(end_date);
CREATE INDEX idx_works_created_at ON works(created_at);
```

**제약 조건**:
```sql
ALTER TABLE works
  ADD CONSTRAINT chk_works_status CHECK (status IN ('PENDING', 'IN_PROGRESS', 'COMPLETED'));
```

### 3.4 work_assignments (업무 배정)
**설명**: 사용자와 약국에 대한 업무 배정 정보를 관리하는 테이블

| 컬럼명 | 데이터 타입 | NULL | 키 | 기본값 | 설명 |
|--------|------------|------|-----|--------|------|
| id | BIGINT | NO | PK | AUTO_INCREMENT | 업무 배정 ID |
| user_id | BIGINT | NO | FK | | 사용자 ID |
| work_id | BIGINT | NO | FK | | 업무 ID |
| pharmacy_id | BIGINT | NO | FK | | 약국 ID |
| status | VARCHAR(20) | NO | | ASSIGNED | 배정 상태 (ASSIGNED, VISITED, REGISTERED, COMPLETED) |
| visited_at | DATETIME | YES | | NULL | 방문 완료 일시 |
| registered_at | DATETIME | YES | | NULL | 회원가입 완료 일시 |
| survey_url | VARCHAR(500) | YES | | NULL | 구글 설문 URL |
| survey_completed | BOOLEAN | NO | | FALSE | 설문 완료 여부 |
| created_at | DATETIME | NO | | CURRENT_TIMESTAMP | 생성 일시 |
| updated_at | DATETIME | NO | | CURRENT_TIMESTAMP | 수정 일시 |
| deleted_at | DATETIME | YES | | NULL | 삭제 일시 (Soft Delete) |

**인덱스**:
```sql
CREATE INDEX idx_work_assignments_user_id ON work_assignments(user_id);
CREATE INDEX idx_work_assignments_work_id ON work_assignments(work_id);
CREATE INDEX idx_work_assignments_pharmacy_id ON work_assignments(pharmacy_id);
CREATE INDEX idx_work_assignments_status ON work_assignments(status);
CREATE INDEX idx_work_assignments_visited_at ON work_assignments(visited_at);
CREATE INDEX idx_work_assignments_registered_at ON work_assignments(registered_at);
CREATE INDEX idx_work_assignments_created_at ON work_assignments(created_at);
CREATE UNIQUE INDEX idx_work_assignments_unique ON work_assignments(user_id, work_id, pharmacy_id) WHERE deleted_at IS NULL;
```

**외래키**:
```sql
ALTER TABLE work_assignments
  ADD CONSTRAINT fk_work_assignments_user_id FOREIGN KEY (user_id) REFERENCES users(id),
  ADD CONSTRAINT fk_work_assignments_work_id FOREIGN KEY (work_id) REFERENCES works(id),
  ADD CONSTRAINT fk_work_assignments_pharmacy_id FOREIGN KEY (pharmacy_id) REFERENCES pharmacies(id);
```

**제약 조건**:
```sql
ALTER TABLE work_assignments
  ADD CONSTRAINT chk_work_assignments_status CHECK (status IN ('ASSIGNED', 'VISITED', 'REGISTERED', 'COMPLETED'));
```

### 3.5 visit_records (방문 기록)
**설명**: 약국 방문 기록을 관리하는 테이블

| 컬럼명 | 데이터 타입 | NULL | 키 | 기본값 | 설명 |
|--------|------------|------|-----|--------|------|
| id | BIGINT | NO | PK | AUTO_INCREMENT | 방문 기록 ID |
| user_id | BIGINT | NO | FK | | 사용자 ID |
| pharmacy_id | BIGINT | NO | FK | | 약국 ID |
| work_assignment_id | BIGINT | YES | FK | NULL | 업무 배정 ID |
| visited_at | DATETIME | NO | | CURRENT_TIMESTAMP | 방문 일시 |
| notes | TEXT | YES | | NULL | 방문 메모 |
| created_at | DATETIME | NO | | CURRENT_TIMESTAMP | 생성 일시 |
| updated_at | DATETIME | NO | | CURRENT_TIMESTAMP | 수정 일시 |
| deleted_at | DATETIME | YES | | NULL | 삭제 일시 (Soft Delete) |

**인덱스**:
```sql
CREATE INDEX idx_visit_records_user_id ON visit_records(user_id);
CREATE INDEX idx_visit_records_pharmacy_id ON visit_records(pharmacy_id);
CREATE INDEX idx_visit_records_work_assignment_id ON visit_records(work_assignment_id);
CREATE INDEX idx_visit_records_visited_at ON visit_records(visited_at);
CREATE INDEX idx_visit_records_created_at ON visit_records(created_at);
```

**외래키**:
```sql
ALTER TABLE visit_records
  ADD CONSTRAINT fk_visit_records_user_id FOREIGN KEY (user_id) REFERENCES users(id),
  ADD CONSTRAINT fk_visit_records_pharmacy_id FOREIGN KEY (pharmacy_id) REFERENCES pharmacies(id),
  ADD CONSTRAINT fk_visit_records_work_assignment_id FOREIGN KEY (work_assignment_id) REFERENCES work_assignments(id);
```

### 3.6 registration_records (회원가입 기록)
**설명**: 약국 회원가입 기록을 관리하는 테이블

| 컬럼명 | 데이터 타입 | NULL | 키 | 기본값 | 설명 |
|--------|------------|------|-----|--------|------|
| id | BIGINT | NO | PK | AUTO_INCREMENT | 회원가입 기록 ID |
| user_id | BIGINT | NO | FK | | 사용자 ID |
| pharmacy_id | BIGINT | NO | FK | | 약국 ID |
| work_assignment_id | BIGINT | YES | FK | NULL | 업무 배정 ID |
| registered_at | DATETIME | NO | | CURRENT_TIMESTAMP | 회원가입 일시 |
| notes | TEXT | YES | | NULL | 가입 메모 |
| created_at | DATETIME | NO | | CURRENT_TIMESTAMP | 생성 일시 |
| updated_at | DATETIME | NO | | CURRENT_TIMESTAMP | 수정 일시 |
| deleted_at | DATETIME | YES | | NULL | 삭제 일시 (Soft Delete) |

**인덱스**:
```sql
CREATE INDEX idx_registration_records_user_id ON registration_records(user_id);
CREATE INDEX idx_registration_records_pharmacy_id ON registration_records(pharmacy_id);
CREATE INDEX idx_registration_records_work_assignment_id ON registration_records(work_assignment_id);
CREATE INDEX idx_registration_records_registered_at ON registration_records(registered_at);
CREATE INDEX idx_registration_records_created_at ON registration_records(created_at);
```

**외래키**:
```sql
ALTER TABLE registration_records
  ADD CONSTRAINT fk_registration_records_user_id FOREIGN KEY (user_id) REFERENCES users(id),
  ADD CONSTRAINT fk_registration_records_pharmacy_id FOREIGN KEY (pharmacy_id) REFERENCES pharmacies(id),
  ADD CONSTRAINT fk_registration_records_work_assignment_id FOREIGN KEY (work_assignment_id) REFERENCES work_assignments(id);
```

### 3.7 notices (공지사항)
**설명**: 공지사항 정보를 관리하는 테이블

| 컬럼명 | 데이터 타입 | NULL | 키 | 기본값 | 설명 |
|--------|------------|------|-----|--------|------|
| id | BIGINT | NO | PK | AUTO_INCREMENT | 공지사항 ID |
| category | VARCHAR(50) | NO | | | 카테고리 |
| title | VARCHAR(200) | NO | | | 제목 |
| content | TEXT | NO | | | 내용 (HTML) |
| author | VARCHAR(50) | NO | | | 작성자 |
| has_image | BOOLEAN | NO | | FALSE | 이미지 포함 여부 |
| view_count | INT | NO | | 0 | 조회수 |
| created_at | DATETIME | NO | | CURRENT_TIMESTAMP | 생성 일시 |
| updated_at | DATETIME | NO | | CURRENT_TIMESTAMP | 수정 일시 |
| deleted_at | DATETIME | YES | | NULL | 삭제 일시 (Soft Delete) |

**인덱스**:
```sql
CREATE INDEX idx_notices_category ON notices(category);
CREATE INDEX idx_notices_author ON notices(author);
CREATE INDEX idx_notices_created_at ON notices(created_at DESC);
CREATE INDEX idx_notices_view_count ON notices(view_count);
```

## 4. 초기 데이터 (Seed Data)

### 4.1 관리자 계정
```sql
INSERT INTO users (email, password, name, phone_number, university, role, status, created_at, updated_at)
VALUES ('admin@picofriends.com', '$2a$10$...', 'Admin', '010-0000-0000', 'SEOUL', 'ADMIN', 'APPROVED', NOW(), NOW());
```

### 4.2 대학교 리스트 (Enum 또는 별도 테이블로 관리 가능)
37개 대학교 목록은 애플리케이션 레벨에서 Enum으로 관리하거나, 필요시 별도 universities 테이블로 관리 가능합니다.

## 5. 데이터베이스 생성 스크립트

### 5.1 MySQL
```sql
-- 데이터베이스 생성
CREATE DATABASE IF NOT EXISTS picofriends
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;

USE picofriends;

-- users 테이블
CREATE TABLE users (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  email VARCHAR(100) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  name VARCHAR(50) NOT NULL,
  phone_number VARCHAR(20) NOT NULL,
  university VARCHAR(50) NOT NULL,
  role VARCHAR(20) NOT NULL CHECK (role IN ('ADMIN', 'PICOFRIEND')),
  status VARCHAR(20) NOT NULL DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'APPROVED', 'REJECTED')),
  admin_comment TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  INDEX idx_users_email (email),
  INDEX idx_users_role (role),
  INDEX idx_users_status (status),
  INDEX idx_users_university (university),
  INDEX idx_users_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- pharmacies 테이블
CREATE TABLE pharmacies (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  address VARCHAR(255) NOT NULL,
  phone_number VARCHAR(20),
  pharmacist_name VARCHAR(50),
  pharmacist_contact VARCHAR(20),
  online_usage_status TEXT,
  main_products TEXT,
  urgent_needs TEXT,
  marketing_concerns TEXT,
  pico_response TEXT,
  field_activity_summary TEXT,
  next_step_plan TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  INDEX idx_pharmacies_name (name),
  INDEX idx_pharmacies_address (address),
  INDEX idx_pharmacies_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- works 테이블
CREATE TABLE works (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  status VARCHAR(20) NOT NULL DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'IN_PROGRESS', 'COMPLETED')),
  start_date DATE,
  end_date DATE,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  INDEX idx_works_status (status),
  INDEX idx_works_start_date (start_date),
  INDEX idx_works_end_date (end_date),
  INDEX idx_works_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- work_assignments 테이블
CREATE TABLE work_assignments (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  work_id BIGINT NOT NULL,
  pharmacy_id BIGINT NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'ASSIGNED' CHECK (status IN ('ASSIGNED', 'VISITED', 'REGISTERED', 'COMPLETED')),
  visited_at DATETIME,
  registered_at DATETIME,
  survey_url VARCHAR(500),
  survey_completed BOOLEAN NOT NULL DEFAULT FALSE,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  INDEX idx_work_assignments_user_id (user_id),
  INDEX idx_work_assignments_work_id (work_id),
  INDEX idx_work_assignments_pharmacy_id (pharmacy_id),
  INDEX idx_work_assignments_status (status),
  INDEX idx_work_assignments_visited_at (visited_at),
  INDEX idx_work_assignments_registered_at (registered_at),
  INDEX idx_work_assignments_created_at (created_at),
  UNIQUE INDEX idx_work_assignments_unique (user_id, work_id, pharmacy_id, deleted_at),
  CONSTRAINT fk_work_assignments_user_id FOREIGN KEY (user_id) REFERENCES users(id),
  CONSTRAINT fk_work_assignments_work_id FOREIGN KEY (work_id) REFERENCES works(id),
  CONSTRAINT fk_work_assignments_pharmacy_id FOREIGN KEY (pharmacy_id) REFERENCES pharmacies(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- visit_records 테이블
CREATE TABLE visit_records (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  pharmacy_id BIGINT NOT NULL,
  work_assignment_id BIGINT,
  visited_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  INDEX idx_visit_records_user_id (user_id),
  INDEX idx_visit_records_pharmacy_id (pharmacy_id),
  INDEX idx_visit_records_work_assignment_id (work_assignment_id),
  INDEX idx_visit_records_visited_at (visited_at),
  INDEX idx_visit_records_created_at (created_at),
  CONSTRAINT fk_visit_records_user_id FOREIGN KEY (user_id) REFERENCES users(id),
  CONSTRAINT fk_visit_records_pharmacy_id FOREIGN KEY (pharmacy_id) REFERENCES pharmacies(id),
  CONSTRAINT fk_visit_records_work_assignment_id FOREIGN KEY (work_assignment_id) REFERENCES work_assignments(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- registration_records 테이블
CREATE TABLE registration_records (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  pharmacy_id BIGINT NOT NULL,
  work_assignment_id BIGINT,
  registered_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  INDEX idx_registration_records_user_id (user_id),
  INDEX idx_registration_records_pharmacy_id (pharmacy_id),
  INDEX idx_registration_records_work_assignment_id (work_assignment_id),
  INDEX idx_registration_records_registered_at (registered_at),
  INDEX idx_registration_records_created_at (created_at),
  CONSTRAINT fk_registration_records_user_id FOREIGN KEY (user_id) REFERENCES users(id),
  CONSTRAINT fk_registration_records_pharmacy_id FOREIGN KEY (pharmacy_id) REFERENCES pharmacies(id),
  CONSTRAINT fk_registration_records_work_assignment_id FOREIGN KEY (work_assignment_id) REFERENCES work_assignments(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- notices 테이블
CREATE TABLE notices (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  category VARCHAR(50) NOT NULL,
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  author VARCHAR(50) NOT NULL,
  has_image BOOLEAN NOT NULL DEFAULT FALSE,
  view_count INT NOT NULL DEFAULT 0,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  INDEX idx_notices_category (category),
  INDEX idx_notices_author (author),
  INDEX idx_notices_created_at (created_at DESC),
  INDEX idx_notices_view_count (view_count)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 6. 주요 쿼리 예시

### 6.1 랭킹 조회 (일간)
```sql
SELECT
  u.id,
  u.name,
  u.university,
  COUNT(DISTINCT vr.id) + COUNT(DISTINCT rr.id) AS total_score,
  COUNT(DISTINCT vr.id) AS visit_count,
  COUNT(DISTINCT rr.id) AS registration_count,
  MIN(COALESCE(vr.visited_at, rr.registered_at)) AS first_record_time
FROM users u
LEFT JOIN visit_records vr ON u.id = vr.user_id
  AND DATE(vr.visited_at) = CURDATE()
  AND vr.deleted_at IS NULL
LEFT JOIN registration_records rr ON u.id = rr.user_id
  AND DATE(rr.registered_at) = CURDATE()
  AND rr.deleted_at IS NULL
WHERE u.role = 'PICOFRIEND'
  AND u.status = 'APPROVED'
  AND u.deleted_at IS NULL
GROUP BY u.id, u.name, u.university
ORDER BY total_score DESC, first_record_time ASC
LIMIT 10;
```

### 6.2 랭킹 조회 (주간)
```sql
SELECT
  u.id,
  u.name,
  u.university,
  COUNT(DISTINCT vr.id) + COUNT(DISTINCT rr.id) AS total_score,
  COUNT(DISTINCT vr.id) AS visit_count,
  COUNT(DISTINCT rr.id) AS registration_count,
  MIN(COALESCE(vr.visited_at, rr.registered_at)) AS first_record_time
FROM users u
LEFT JOIN visit_records vr ON u.id = vr.user_id
  AND YEARWEEK(vr.visited_at, 1) = YEARWEEK(CURDATE(), 1)
  AND vr.deleted_at IS NULL
LEFT JOIN registration_records rr ON u.id = rr.user_id
  AND YEARWEEK(rr.registered_at, 1) = YEARWEEK(CURDATE(), 1)
  AND rr.deleted_at IS NULL
WHERE u.role = 'PICOFRIEND'
  AND u.status = 'APPROVED'
  AND u.deleted_at IS NULL
GROUP BY u.id, u.name, u.university
ORDER BY total_score DESC, first_record_time ASC
LIMIT 10;
```

### 6.3 대시보드 통계 (오늘)
```sql
SELECT
  COUNT(DISTINCT vr.pharmacy_id) AS today_pharmacy_visits,
  COUNT(DISTINCT rr.pharmacy_id) AS today_registrations
FROM visit_records vr
LEFT JOIN registration_records rr ON DATE(rr.registered_at) = CURDATE()
  AND rr.deleted_at IS NULL
WHERE DATE(vr.visited_at) = CURDATE()
  AND vr.deleted_at IS NULL;
```

### 6.4 업무 배정 현황
```sql
SELECT
  wa.id,
  u.name AS user_name,
  w.title AS work_title,
  p.name AS pharmacy_name,
  p.address AS pharmacy_address,
  wa.status,
  wa.visited_at,
  wa.registered_at,
  wa.survey_completed
FROM work_assignments wa
INNER JOIN users u ON wa.user_id = u.id
INNER JOIN works w ON wa.work_id = w.id
INNER JOIN pharmacies p ON wa.pharmacy_id = p.id
WHERE wa.deleted_at IS NULL
  AND u.deleted_at IS NULL
  AND w.deleted_at IS NULL
  AND p.deleted_at IS NULL
ORDER BY wa.created_at DESC;
```

### 6.5 전환율 계산
```sql
SELECT
  u.id,
  u.name,
  COUNT(DISTINCT vr.id) AS visit_count,
  COUNT(DISTINCT rr.id) AS registration_count,
  ROUND(
    CASE
      WHEN COUNT(DISTINCT vr.id) > 0 THEN
        (COUNT(DISTINCT rr.id) * 100.0 / COUNT(DISTINCT vr.id))
      ELSE 0
    END,
    2
  ) AS conversion_rate
FROM users u
LEFT JOIN visit_records vr ON u.id = vr.user_id
  AND vr.deleted_at IS NULL
LEFT JOIN registration_records rr ON u.id = rr.user_id
  AND rr.deleted_at IS NULL
WHERE u.role = 'PICOFRIEND'
  AND u.status = 'APPROVED'
  AND u.deleted_at IS NULL
GROUP BY u.id, u.name;
```

## 7. 백업 및 복구 전략

### 7.1 일일 백업
```bash
# 전체 데이터베이스 백업
mysqldump -u root -p picofriends > backup_$(date +%Y%m%d).sql

# 특정 테이블 백업
mysqldump -u root -p picofriends users pharmacies > backup_tables_$(date +%Y%m%d).sql
```

### 7.2 복구
```bash
mysql -u root -p picofriends < backup_20251020.sql
```

## 8. 성능 최적화 권장사항

1. **인덱스 최적화**: 자주 조회되는 컬럼에 인덱스 추가
2. **파티셔닝**: visit_records, registration_records 테이블은 날짜 기준 파티셔닝 고려
3. **쿼리 최적화**: EXPLAIN을 통한 쿼리 성능 분석
4. **커넥션 풀**: HikariCP 설정 최적화
5. **캐싱**: Redis를 활용한 랭킹 및 통계 데이터 캐싱
6. **읽기 전용 복제본**: 조회 성능 향상을 위한 Read Replica 구성

## 9. 보안 고려사항

1. **비밀번호 암호화**: BCrypt 알고리즘 사용
2. **SQL Injection 방지**: Prepared Statement 사용
3. **데이터베이스 권한 분리**: 애플리케이션용 계정과 관리자 계정 분리
4. **Soft Delete**: 중요 데이터는 물리적 삭제 대신 Soft Delete 사용
5. **감사 로그**: 중요 작업에 대한 감사 로그 테이블 추가 고려
